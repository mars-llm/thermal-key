<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thermal Key Release Asset Scanner</title>
  <meta name="description" content="Scan GitHub releases for new Thermal Key assets. Local-first, no tracking." />
  <meta name="keywords" content="Thermal Key, GitHub releases, asset scanner, Avalon Mini 3, Nano 3S" />
  <meta name="author" content="Thermal Key" />
  <link rel="canonical" href="https://mars-llm.github.io/thermal-key/" />

  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Thermal Key" />
  <meta property="og:title" content="Thermal Key Release Asset Scanner" />
  <meta property="og:description" content="Scan GitHub releases for new assets. Local-first, no tracking." />
  <meta property="og:url" content="https://mars-llm.github.io/thermal-key/" />
  <meta property="og:image" content="https://mars-llm.github.io/thermal-key/assets/thermal-key.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Thermal Key Release Asset Scanner" />
  <meta name="twitter:description" content="Scan GitHub releases for new assets. Local-first, no tracking." />
  <meta name="twitter:image" content="https://mars-llm.github.io/thermal-key/assets/thermal-key.png" />
  <meta name="theme-color" content="#0ea5e9" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #0a0f14;
      --bg-soft: #111821;
      --panel: #0f1720;
      --ink: #e9f1f8;
      --muted: #9fb0c0;
      --accent: #0ea5e9;
      --accent-2: #22d3ee;
      --warning: #f97316;
      --ok: #22c55e;
      --stroke: rgba(255, 255, 255, 0.08);
      --shadow: 0 24px 80px rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "IBM Plex Sans", system-ui, -apple-system, sans-serif;
      background: radial-gradient(1200px 700px at 15% -10%, rgba(34, 211, 238, 0.16), transparent 60%),
                  radial-gradient(900px 480px at 90% 10%, rgba(14, 165, 233, 0.2), transparent 60%),
                  var(--bg);
      color: var(--ink);
      min-height: 100vh;
    }

    a { color: inherit; }

    header {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 24px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .brand img {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: var(--panel);
    }

    .logo {
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 12px;
      color: var(--muted);
    }

    .subtitle {
      font-size: 18px;
      font-weight: 600;
    }

    nav a {
      text-decoration: none;
      margin-left: 16px;
      font-size: 14px;
      color: var(--muted);
      transition: color 0.2s ease;
    }

    nav a:hover { color: var(--ink); }

    nav a:focus-visible {
      outline: 2px solid var(--accent-2);
      outline-offset: 4px;
      border-radius: 8px;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 24px 60px;
      display: grid;
      gap: 24px;
    }

    .hero {
      background: rgba(15, 23, 32, 0.92);
      border: 1px solid var(--stroke);
      border-radius: 20px;
      padding: 28px;
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 20px;
      align-items: start;
    }

    h1 {
      margin: 0 0 12px;
      font-size: clamp(28px, 3.6vw, 46px);
      line-height: 1.05;
    }

    .hero p {
      margin: 0 0 18px;
      color: var(--muted);
      font-size: 16px;
      line-height: 1.6;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 18px;
    }

    .field {
      display: grid;
      gap: 8px;
      margin-bottom: 14px;
    }

    label {
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
    }

    input[type="text"] {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255, 255, 255, 0.03);
      color: var(--ink);
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 14px;
    }

    input[type="text"]:focus-visible {
      outline: 2px solid var(--accent-2);
      outline-offset: 2px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--muted);
    }

    .toggle input {
      accent-color: var(--accent);
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    button {
      border: 1px solid var(--stroke);
      background: rgba(255, 255, 255, 0.04);
      color: var(--ink);
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
      font-weight: 600;
    }

    button.primary {
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      color: #04121a;
      border: none;
    }

    button:hover {
      transform: translateY(-1px);
      border-color: rgba(255, 255, 255, 0.2);
    }

    button:focus-visible {
      outline: 2px solid var(--accent-2);
      outline-offset: 3px;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      border: 1px solid transparent;
      background: rgba(255, 255, 255, 0.03);
    }

    .status.info { border-color: rgba(14, 165, 233, 0.4); }
    .status.error { border-color: rgba(249, 115, 22, 0.6); color: #ffd4b8; }
    .status.ok { border-color: rgba(34, 197, 94, 0.5); color: #bbf7d0; }

    .summary {
      font-size: 14px;
      color: var(--muted);
      margin-top: 6px;
    }

    .results {
      display: grid;
      gap: 18px;
    }

    .release {
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 18px;
      background: var(--bg-soft);
    }

    .release h3 {
      margin: 0 0 6px;
      font-size: 18px;
    }

    .release-meta {
      font-size: 13px;
      color: var(--muted);
    }

    .assets {
      margin-top: 12px;
      display: grid;
      gap: 10px;
    }

    .asset {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255, 255, 255, 0.02);
    }

    .asset.new {
      border-color: rgba(34, 197, 94, 0.6);
      background: rgba(34, 197, 94, 0.08);
    }

    .asset-name {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 13px;
      color: var(--ink);
      word-break: break-all;
    }

    .asset-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .badge {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: rgba(255, 255, 255, 0.06);
      color: var(--muted);
      border: 1px solid var(--stroke);
    }

    .settings {
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 16px;
    }

    details summary {
      cursor: pointer;
      list-style: none;
      font-weight: 600;
    }

    details summary::-webkit-details-marker { display: none; }

    .settings-grid {
      margin-top: 12px;
      display: grid;
      gap: 10px;
    }

    .footer {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      padding-top: 10px;
    }

    @media (max-width: 960px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .hero {
        grid-template-columns: 1fr;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="assets/thermal-key.png" alt="Thermal Key logo" />
      <div>
        <div class="logo">Thermal Key</div>
        <div class="subtitle">Release Asset Scanner</div>
      </div>
    </div>
    <nav>
      <a href="https://github.com/mars-llm/thermal-key">GitHub</a>
      <a href="https://mars-llm.github.io/thermal-key/">Pages</a>
    </nav>
  </header>

  <main>
    <section class="hero">
      <div>
        <h1>Scan GitHub releases for new assets.</h1>
        <p>Track release assets with a local-first scanner. No tracking, no cookies. New assets are highlighted and remembered in your browser.</p>
        <div class="panel">
          <div class="field">
            <label for="repo">Repository</label>
            <input id="repo" type="text" value="mars-llm/thermal-key" />
          </div>
          <div class="field">
            <label for="filter">Asset filter (regex or substring)</label>
            <input id="filter" type="text" placeholder="e.g. .zip or firmware" />
          </div>
          <div class="row">
            <label class="toggle"><input id="includePre" type="checkbox" /> Include prereleases</label>
            <label class="toggle"><input id="includeDrafts" type="checkbox" /> Include drafts</label>
          </div>
          <div class="actions">
            <button class="primary" id="scan">Scan releases</button>
            <button id="clear">Clear seen</button>
          </div>
          <div id="status" class="status info">Ready.</div>
          <div id="summary" class="summary"></div>
        </div>
      </div>

      <div class="panel settings">
        <details open>
          <summary>Settings</summary>
          <div class="settings-grid">
            <label class="toggle"><input id="useProxy" type="checkbox" /> Enable proxy fallback</label>
            <div class="field">
              <label for="proxyUrl">Proxy URL (optional)</label>
              <input id="proxyUrl" type="text" value="https://corsproxy.io/?" />
            </div>
            <div class="summary">If direct API fails, the scanner can try a CORS proxy. Default uses corsproxy.io.</div>
          </div>
        </details>
      </div>
    </section>

    <section class="results" id="results">
      <div class="release">
        <h3>Results</h3>
        <div class="release-meta">No scan yet.</div>
      </div>
    </section>

    <div class="footer">Local storage only. Clear seen assets any time.</div>
  </main>

  <noscript>
    <div style="color:#fff; padding:20px;">This page requires JavaScript to scan releases.</div>
  </noscript>

  <script>
    const STORAGE_SETTINGS = "tk_scanner_settings";
    const STORAGE_SEEN = "tk_scanner_seen";

    const repoInput = document.getElementById("repo");
    const filterInput = document.getElementById("filter");
    const includePre = document.getElementById("includePre");
    const includeDrafts = document.getElementById("includeDrafts");
    const scanBtn = document.getElementById("scan");
    const clearBtn = document.getElementById("clear");
    const statusEl = document.getElementById("status");
    const summaryEl = document.getElementById("summary");
    const resultsEl = document.getElementById("results");
    const useProxy = document.getElementById("useProxy");
    const proxyUrl = document.getElementById("proxyUrl");

    function setStatus(text, type) {
      statusEl.textContent = text;
      statusEl.className = `status ${type || "info"}`;
    }

    function formatBytes(bytes) {
      if (!bytes && bytes !== 0) return "";
      const units = ["B", "KB", "MB", "GB"];
      let size = bytes;
      let idx = 0;
      while (size >= 1024 && idx < units.length - 1) {
        size /= 1024;
        idx++;
      }
      return `${size.toFixed(size >= 10 || idx === 0 ? 0 : 1)} ${units[idx]}`;
    }

    function normalizeRepo(text) {
      const trimmed = text.trim();
      if (!trimmed) return "";
      if (trimmed.includes("github.com")) {
        const parts = trimmed.replace(/^https?:\/\//, "").split("/").filter(Boolean);
        const idx = parts.indexOf("github.com");
        if (idx >= 0 && parts.length >= idx + 3) {
          return `${parts[idx + 1]}/${parts[idx + 2]}`;
        }
      }
      return trimmed;
    }

    function loadSettings() {
      try {
        const saved = JSON.parse(localStorage.getItem(STORAGE_SETTINGS) || "{}");
        if (saved.repo) repoInput.value = saved.repo;
        if (saved.filter) filterInput.value = saved.filter;
        includePre.checked = !!saved.includePre;
        includeDrafts.checked = !!saved.includeDrafts;
        useProxy.checked = !!saved.useProxy;
        if (saved.proxyUrl) proxyUrl.value = saved.proxyUrl;
      } catch (_) {
        // ignore
      }
    }

    function saveSettings() {
      const settings = {
        repo: repoInput.value.trim(),
        filter: filterInput.value.trim(),
        includePre: includePre.checked,
        includeDrafts: includeDrafts.checked,
        useProxy: useProxy.checked,
        proxyUrl: proxyUrl.value.trim(),
      };
      localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(settings));
    }

    function loadSeen() {
      try {
        const data = JSON.parse(localStorage.getItem(STORAGE_SEEN) || "[]");
        return new Set(Array.isArray(data) ? data : []);
      } catch (_) {
        return new Set();
      }
    }

    function saveSeen(set) {
      localStorage.setItem(STORAGE_SEEN, JSON.stringify(Array.from(set)));
    }

    function proxyWrap(url) {
      const base = proxyUrl.value.trim() || "https://corsproxy.io/?";
      if (base.includes("{url}")) {
        return base.replace("{url}", encodeURIComponent(url));
      }
      return base + encodeURIComponent(url);
    }

    async function fetchJson(url, allowProxy) {
      const headers = {
        "Accept": "application/vnd.github+json",
      };
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 12000);
      try {
        const res = await fetch(url, { headers, signal: controller.signal, cache: "no-store" });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || `HTTP ${res.status}`);
        }
        return await res.json();
      } catch (err) {
        if (!allowProxy) throw err;
        const proxy = proxyWrap(url);
        const res = await fetch(proxy, { headers, cache: "no-store" });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || `HTTP ${res.status}`);
        }
        return await res.json();
      } finally {
        clearTimeout(timeout);
      }
    }

    async function fetchReleases(repo) {
      const perPage = 50;
      const pages = 3;
      let all = [];
      for (let page = 1; page <= pages; page++) {
        const url = `https://api.github.com/repos/${repo}/releases?per_page=${perPage}&page=${page}`;
        const data = await fetchJson(url, useProxy.checked);
        if (!Array.isArray(data)) {
          throw new Error("Unexpected API response");
        }
        all = all.concat(data);
        if (data.length < perPage) break;
      }
      return all;
    }

    function buildFilter(text) {
      if (!text) return null;
      try {
        return new RegExp(text, "i");
      } catch (_) {
        return null;
      }
    }

    function matchesFilter(name, text, regex) {
      if (!text) return true;
      if (regex) return regex.test(name);
      return name.toLowerCase().includes(text.toLowerCase());
    }

    function renderResults(releases, seen) {
      resultsEl.innerHTML = "";
      if (!releases.length) {
        resultsEl.innerHTML = '<div class="release"><h3>No releases found</h3><div class="release-meta">Try a different repository.</div></div>';
        return { assetTotal: 0, newCount: 0 };
      }

      let assetTotal = 0;
      let newCount = 0;

      for (const rel of releases) {
        const releaseEl = document.createElement("div");
        releaseEl.className = "release";
        const title = rel.name || rel.tag_name || "Untitled release";
        const published = rel.published_at ? new Date(rel.published_at).toLocaleString() : "Unpublished";
        const draftLabel = rel.draft ? "draft" : rel.prerelease ? "prerelease" : "release";

        releaseEl.innerHTML = `
          <h3>${title}</h3>
          <div class="release-meta">${rel.tag_name || ""} · ${published} · <span class="badge">${draftLabel}</span></div>
        `;

        const assetsWrap = document.createElement("div");
        assetsWrap.className = "assets";

        if (!rel.assets || !rel.assets.length) {
          const empty = document.createElement("div");
          empty.className = "asset";
          empty.innerHTML = '<div class="asset-name">No assets</div><div class="asset-meta"></div>';
          assetsWrap.appendChild(empty);
        } else {
          for (const asset of rel.assets) {
            assetTotal++;
            const id = String(asset.id || asset.name);
            const isNew = !seen.has(id);
            if (isNew) {
              newCount++;
            }
            const assetEl = document.createElement("div");
            assetEl.className = "asset" + (isNew ? " new" : "");
            assetEl.innerHTML = `
              <div>
                <div class="asset-name"><a href="${asset.browser_download_url}" target="_blank" rel="noopener">${asset.name}</a></div>
                <div class="asset-meta">${formatBytes(asset.size)} · ${asset.download_count || 0} downloads</div>
              </div>
              <div class="badge">${isNew ? "new" : "seen"}</div>
            `;
            assetsWrap.appendChild(assetEl);
            seen.add(id);
          }
        }

        releaseEl.appendChild(assetsWrap);
        resultsEl.appendChild(releaseEl);
      }

      return { assetTotal, newCount };
    }

    async function scan() {
      saveSettings();
      const repo = normalizeRepo(repoInput.value);
      if (!repo || !repo.includes("/")) {
        setStatus("Enter repository as owner/name.", "error");
        return;
      }

      scanBtn.disabled = true;
      setStatus("Scanning releases...", "info");
      summaryEl.textContent = "";

      try {
        const releases = await fetchReleases(repo);
        const filterText = filterInput.value.trim();
        const regex = buildFilter(filterText);
        const filtered = releases
          .filter(rel => includeDrafts.checked || !rel.draft)
          .filter(rel => includePre.checked || !rel.prerelease)
          .map(rel => {
            if (!filterText) return rel;
            const assets = (rel.assets || []).filter(asset => matchesFilter(asset.name, filterText, regex));
            return { ...rel, assets };
          })
          .filter(rel => rel.assets && rel.assets.length || !filterText);

        const seen = loadSeen();
        const { assetTotal, newCount } = renderResults(filtered, seen);
        saveSeen(seen);

        const releaseCount = filtered.length;
        setStatus(`Scan complete. ${newCount} new assets.`, newCount ? "ok" : "info");
        summaryEl.textContent = `${releaseCount} releases · ${assetTotal} assets · ${newCount} new`;
      } catch (err) {
        const message = err && err.message ? err.message : String(err);
        if (!useProxy.checked && message === "Failed to fetch") {
          setStatus("Direct API failed (Failed to fetch). Enable proxy fallback in Settings or open the HTML file locally.", "error");
        } else {
          setStatus(message, "error");
        }
      } finally {
        scanBtn.disabled = false;
      }
    }

    function clearSeen() {
      localStorage.removeItem(STORAGE_SEEN);
      setStatus("Cleared seen assets.", "info");
      summaryEl.textContent = "";
    }

    [repoInput, filterInput, includePre, includeDrafts, useProxy, proxyUrl].forEach(el => {
      el.addEventListener("change", saveSettings);
    });

    scanBtn.addEventListener("click", scan);
    clearBtn.addEventListener("click", clearSeen);

    loadSettings();
  </script>
</body>
</html>
